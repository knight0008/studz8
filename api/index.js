// Vercel Serverless Function Ù„Ù„Ù€ API
const express = require('express');
const cors = require('cors');
require('dotenv').config();

// Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¥Ù†ØªØ§Ø¬
const { executeQuery, testConnection } = require('../server/config/database-production');

const app = express();

// Middleware
app.use(cors({
  origin: ['https://your-vercel-app.vercel.app', 'http://localhost:5173'],
  credentials: true
}));
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Ø§Ø®ØªØ¨Ø§Ø± API
app.get('/api/test', (req, res) => {
  console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± API Ø¹Ù„Ù‰ Vercel');
  res.json({ 
    success: true, 
    message: 'API ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ø¹Ù„Ù‰ Vercel',
    timestamp: new Date().toISOString(),
    environment: 'production'
  });
});

// Ø§Ø®ØªØ¨Ø§Ø± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
app.get('/api/db-test', async (req, res) => {
  try {
    console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Hostinger...');
    const connected = await testConnection();
    
    if (connected) {
      const users = await executeQuery('SELECT COUNT(*) as count FROM users');
      res.json({
        success: true,
        message: 'Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØµÙ„Ø© Ø¨Ù†Ø¬Ø§Ø­',
        userCount: users[0].count
      });
    } else {
      res.status(500).json({
        success: false,
        message: 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'
      });
    }
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
    res.status(500).json({
      success: false,
      message: 'Ø®Ø·Ø£ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
      error: error.message
    });
  }
});

// Ø§Ø³ØªÙŠØ±Ø§Ø¯ routes Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
const apiRoutes = require('../server/routes/api');
app.use('/api', apiRoutes);

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
app.use((err, req, res, next) => {
  console.error('âŒ Ø®Ø·Ø£ ÙÙŠ API:', err);
  res.status(500).json({ 
    success: false, 
    message: 'Ø®Ø·Ø£ Ø¯Ø§Ø®Ù„ÙŠ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…',
    error: process.env.NODE_ENV === 'development' ? err.message : undefined
  });
});

// ØªØµØ¯ÙŠØ± Ù„Ù„Ù€ Vercel
module.exports = app;